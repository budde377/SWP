package example;

import dk.brics.xact.*;
import dk.brics.xact.operations.*;

import java.util.*;

/**
  * This example file is deliberately left without comments.
  */
public class Example3 {
        private static Map<String, Integer> ids = new HashMap<String,Integer>();
        private static int currentId;
	
	static {
		XML.getNamespaceMap().put("h", "http://www.w3.org/1999/xhtml");
		XML.loadXMLSchema("file:schemas/xhtml1-transitional.dtd");
	}

        public static XML makePicture(XML data) {
            XML entry = [[<h:a name=[ID]><h:h3><[CAPTION]></h:h3></h:a><h:img src=[URL] />]];
            String name = data.getString("//name");
            int id = currentId++;
            ids.put(name, id); 
            return entry.plug("CAPTION", XML.concat(data.getString("//caption")).plug("URL", name));
        }

        private static XML makeTableEntry(XML data) {
            XML entry = [[<h:a href=[LINK]><[CAPTION]></h:a><h:br/>]];
            entry = entry.plug("CAPTION", data.getString("//caption")).plug("LINK", "#" + ids.get(data.getString("//name")));
            return entry;
        }
	
	public static void main(String[] args) {
		XML xml = XML.parseTemplateResource(Example3.class, "example3.xml");
		XML data = XML.parseTemplateResource(Example3.class, "example3_2.xml");
		
	        XML result = xml.plug("TITLE",[[Amazing pictures of my brave adventures!]]);
                XML entryList = [[]];
                XML tableOfContents = [[]];

                for (Node n : data.get("//entry")) {
                    XML x = (XML) n;
                    entryList = XML.concat(entryList, makePicture(x));
                    tableOfContents = XML.concat(tableOfContents, makeTableEntry(x));
                }

                result = result.plug("GALLERY", entryList);
                result = result.plug("TABLE", tableOfContents);
		
                result.analyze("h:html");
		
		System.out.println(result.toTemplate(XMLIndentation.XHTML));
	}
	
}
